<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASIO Audio Waveform Demo - Electron Capture</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 2rem;
            background: linear-gradient(90deg, #00d4ff, #7c3aed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
        }

        .status-bar {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .status-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .status-item.available {
            border-left: 3px solid #10b981;
        }

        .status-item.unavailable {
            border-left: 3px solid #ef4444;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
        }

        select, button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        select {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            min-width: 250px;
        }

        select option {
            background: #1a1a2e;
            color: #fff;
        }

        button {
            background: linear-gradient(90deg, #00d4ff, #7c3aed);
            color: #fff;
            font-weight: 600;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 212, 255, 0.4);
        }

        button:disabled {
            background: #444;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        button.stop {
            background: linear-gradient(90deg, #ef4444, #dc2626);
        }

        .visualizer-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .visualizer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .visualizer-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .level-meter {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .level-bar {
            width: 150px;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .level-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #fbbf24, #ef4444);
            width: 0%;
            transition: width 0.05s;
        }

        .level-db {
            font-size: 0.85rem;
            color: #888;
            min-width: 60px;
            text-align: right;
        }

        canvas {
            width: 100%;
            height: 200px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.2);
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .info-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 12px;
        }

        .info-card h3 {
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-card p {
            font-size: 1.1rem;
            color: #fff;
        }

        .error-message {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .help-text {
            text-align: center;
            color: #666;
            margin-top: 30px;
            font-size: 0.9rem;
        }

        .help-text a {
            color: #00d4ff;
            text-decoration: none;
        }

        .help-text a:hover {
            text-decoration: underline;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .recording-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .recording-dot {
            width: 10px;
            height: 10px;
            background: #ef4444;
            border-radius: 50%;
            animation: pulse 1s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ASIO Audio Waveform</h1>
        <p class="subtitle">Low-latency professional audio capture for Electron Capture</p>

        <div class="status-bar">
            <div class="status-item" id="asioStatus">
                ASIO: Checking...
            </div>
            <div class="status-item" id="versionInfo">
                Version: Loading...
            </div>
        </div>

        <div id="errorContainer"></div>

        <div class="controls">
            <select id="deviceSelect" disabled>
                <option value="">Select ASIO Device...</option>
            </select>
            <button id="startBtn" disabled>Start Capture</button>
            <button id="stopBtn" class="stop" disabled>Stop</button>
        </div>

        <div class="visualizer-container">
            <div class="visualizer-header">
                <span class="visualizer-title" id="visualizerTitle">Waveform</span>
                <div class="level-meter">
                    <div class="level-bar">
                        <div class="level-fill" id="levelFill"></div>
                    </div>
                    <span class="level-db" id="levelDb">-∞ dB</span>
                </div>
            </div>
            <canvas id="waveformCanvas"></canvas>
        </div>

        <div class="visualizer-container">
            <div class="visualizer-header">
                <span class="visualizer-title">Frequency Spectrum</span>
            </div>
            <canvas id="spectrumCanvas"></canvas>
        </div>

        <div class="info-grid">
            <div class="info-card">
                <h3>Sample Rate</h3>
                <p id="sampleRateInfo">--</p>
            </div>
            <div class="info-card">
                <h3>Channels</h3>
                <p id="channelsInfo">--</p>
            </div>
            <div class="info-card">
                <h3>Buffer Size</h3>
                <p id="bufferInfo">--</p>
            </div>
            <div class="info-card">
                <h3>Latency</h3>
                <p id="latencyInfo">--</p>
            </div>
        </div>

        <p class="help-text">
            This demo requires Electron Capture with ASIO support (Windows only).<br>
            Install an ASIO driver like <a href="https://www.asio4all.org/" target="_blank">ASIO4ALL</a>
            or use your audio interface's native ASIO driver.
        </p>
    </div>

    <script>
        // Elements
        const asioStatus = document.getElementById('asioStatus');
        const versionInfo = document.getElementById('versionInfo');
        const errorContainer = document.getElementById('errorContainer');
        const deviceSelect = document.getElementById('deviceSelect');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const visualizerTitle = document.getElementById('visualizerTitle');
        const levelFill = document.getElementById('levelFill');
        const levelDb = document.getElementById('levelDb');
        const waveformCanvas = document.getElementById('waveformCanvas');
        const spectrumCanvas = document.getElementById('spectrumCanvas');
        const sampleRateInfo = document.getElementById('sampleRateInfo');
        const channelsInfo = document.getElementById('channelsInfo');
        const bufferInfo = document.getElementById('bufferInfo');
        const latencyInfo = document.getElementById('latencyInfo');

        // Canvas contexts
        const waveformCtx = waveformCanvas.getContext('2d');
        const spectrumCtx = spectrumCanvas.getContext('2d');

        // State
        let asioStream = null;
        let audioContext = null;
        let analyser = null;
        let dataArray = null;
        let frequencyArray = null;
        let animationId = null;

        // Check if running in Electron with ASIO support
        function checkAsioAvailability() {
            if (typeof window.electronApi === 'undefined') {
                showError('This demo requires Electron Capture. Please open this file in the Electron Capture app with --node flag.');
                return false;
            }

            if (!window.electronApi.isAsioAvailable || !window.electronApi.isAsioAvailable()) {
                showError('ASIO is not available. This feature requires Windows with an ASIO driver installed (e.g., ASIO4ALL or your audio interface\'s ASIO driver).');
                asioStatus.textContent = 'ASIO: Not Available';
                asioStatus.classList.add('unavailable');
                return false;
            }

            asioStatus.textContent = 'ASIO: Available';
            asioStatus.classList.add('available');
            return true;
        }

        function showError(message) {
            errorContainer.innerHTML = `<div class="error-message">${message}</div>`;
        }

        function clearError() {
            errorContainer.innerHTML = '';
        }

        // Initialize
        async function init() {
            // Set up canvas sizes
            resizeCanvases();
            window.addEventListener('resize', resizeCanvases);

            if (!checkAsioAvailability()) {
                return;
            }

            // Get version info
            try {
                const version = window.electronApi.getAsioVersionInfo();
                versionInfo.textContent = `Version: ${version}`;
            } catch (e) {
                versionInfo.textContent = 'Version: Unknown';
            }

            // Load devices
            await loadDevices();
        }

        async function loadDevices() {
            try {
                const devices = window.electronApi.getAsioDevices();

                if (!devices || devices.length === 0) {
                    showError('No ASIO devices found. Please install an ASIO driver (e.g., ASIO4ALL) or check your audio interface.');
                    return;
                }

                clearError();
                deviceSelect.innerHTML = '<option value="">Select ASIO Device...</option>';

                devices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.index;
                    option.textContent = `${device.name} (${device.maxInputChannels}in/${device.maxOutputChannels}out)`;
                    option.dataset.device = JSON.stringify(device);
                    deviceSelect.appendChild(option);
                });

                deviceSelect.disabled = false;
                startBtn.disabled = false;

            } catch (e) {
                showError(`Failed to load ASIO devices: ${e.message}`);
            }
        }

        function resizeCanvases() {
            const dpr = window.devicePixelRatio || 1;

            [waveformCanvas, spectrumCanvas].forEach(canvas => {
                const rect = canvas.getBoundingClientRect();
                canvas.width = rect.width * dpr;
                canvas.height = rect.height * dpr;
                canvas.getContext('2d').scale(dpr, dpr);
            });
        }

        async function startCapture() {
            const selectedOption = deviceSelect.options[deviceSelect.selectedIndex];
            if (!selectedOption || !selectedOption.value) {
                showError('Please select an ASIO device first.');
                return;
            }

            const device = JSON.parse(selectedOption.dataset.device);

            try {
                clearError();

                // Create Web Audio context for visualization
                audioContext = new (window.AudioContext || window.webkitAudioContext)({
                    sampleRate: device.defaultSampleRate
                });

                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
                analyser.smoothingTimeConstant = 0.8;

                const bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);
                frequencyArray = new Uint8Array(bufferLength);

                // Create ASIO stream
                asioStream = window.electronApi.createAsioStream({
                    deviceIndex: parseInt(selectedOption.value),
                    sampleRate: device.defaultSampleRate,
                    channels: Math.min(device.maxInputChannels, 2),
                    framesPerBuffer: 256
                });

                // Handle audio data
                asioStream.on('data', (audioData) => {
                    // Convert audio data to Web Audio for visualization
                    if (audioContext && audioContext.state === 'running') {
                        try {
                            // Create audio buffer from ASIO data
                            const float32Data = new Float32Array(audioData.buffer);
                            const audioBuffer = audioContext.createBuffer(
                                1,
                                float32Data.length,
                                device.defaultSampleRate
                            );
                            audioBuffer.getChannelData(0).set(float32Data);

                            // Play through analyser for visualization
                            const source = audioContext.createBufferSource();
                            source.buffer = audioBuffer;
                            source.connect(analyser);
                            analyser.connect(audioContext.destination);
                            source.start();
                        } catch (e) {
                            // Ignore visualization errors
                        }
                    }
                });

                asioStream.on('error', (err) => {
                    showError(`ASIO Error: ${err.message}`);
                    stopCapture();
                });

                asioStream.start();

                // Update UI
                visualizerTitle.innerHTML = `<span class="recording-indicator"><span class="recording-dot"></span> Recording from ${device.name}</span>`;
                sampleRateInfo.textContent = `${device.defaultSampleRate} Hz`;
                channelsInfo.textContent = `${Math.min(device.maxInputChannels, 2)}`;
                bufferInfo.textContent = '256 samples';
                latencyInfo.textContent = `${(device.defaultLowInputLatency).toFixed(2)} ms`;

                startBtn.disabled = true;
                stopBtn.disabled = false;
                deviceSelect.disabled = true;

                // Start visualization
                draw();

            } catch (e) {
                showError(`Failed to start ASIO capture: ${e.message}`);
                stopCapture();
            }
        }

        function stopCapture() {
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }

            if (asioStream) {
                asioStream.stop();
                asioStream = null;
            }

            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }

            analyser = null;
            dataArray = null;
            frequencyArray = null;

            // Update UI
            visualizerTitle.textContent = 'Waveform';
            levelFill.style.width = '0%';
            levelDb.textContent = '-∞ dB';

            startBtn.disabled = false;
            stopBtn.disabled = true;
            deviceSelect.disabled = false;

            // Clear canvases
            clearCanvas(waveformCtx, waveformCanvas);
            clearCanvas(spectrumCtx, spectrumCanvas);
        }

        function clearCanvas(ctx, canvas) {
            const rect = canvas.getBoundingClientRect();
            ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
            ctx.fillRect(0, 0, rect.width, rect.height);
        }

        function draw() {
            if (!analyser) return;

            animationId = requestAnimationFrame(draw);

            // Get waveform data
            analyser.getByteTimeDomainData(dataArray);
            analyser.getByteFrequencyData(frequencyArray);

            // Calculate level
            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) {
                const value = (dataArray[i] - 128) / 128;
                sum += value * value;
            }
            const rms = Math.sqrt(sum / dataArray.length);
            const db = 20 * Math.log10(rms + 0.0001);
            const normalizedLevel = Math.max(0, Math.min(100, (db + 60) * 1.67));

            levelFill.style.width = `${normalizedLevel}%`;
            levelDb.textContent = `${db.toFixed(1)} dB`;

            // Draw waveform
            drawWaveform();

            // Draw spectrum
            drawSpectrum();
        }

        function drawWaveform() {
            const rect = waveformCanvas.getBoundingClientRect();
            const width = rect.width;
            const height = rect.height;

            waveformCtx.fillStyle = 'rgba(0, 0, 0, 0.1)';
            waveformCtx.fillRect(0, 0, width, height);

            waveformCtx.lineWidth = 2;
            waveformCtx.strokeStyle = '#00d4ff';
            waveformCtx.beginPath();

            const sliceWidth = width / dataArray.length;
            let x = 0;

            for (let i = 0; i < dataArray.length; i++) {
                const v = dataArray[i] / 128.0;
                const y = (v * height) / 2;

                if (i === 0) {
                    waveformCtx.moveTo(x, y);
                } else {
                    waveformCtx.lineTo(x, y);
                }

                x += sliceWidth;
            }

            waveformCtx.lineTo(width, height / 2);
            waveformCtx.stroke();
        }

        function drawSpectrum() {
            const rect = spectrumCanvas.getBoundingClientRect();
            const width = rect.width;
            const height = rect.height;

            spectrumCtx.fillStyle = 'rgba(0, 0, 0, 0.1)';
            spectrumCtx.fillRect(0, 0, width, height);

            const barWidth = (width / frequencyArray.length) * 2.5;
            let x = 0;

            for (let i = 0; i < frequencyArray.length; i++) {
                const barHeight = (frequencyArray[i] / 255) * height;

                // Gradient color based on frequency
                const hue = (i / frequencyArray.length) * 240;
                spectrumCtx.fillStyle = `hsl(${180 + hue}, 80%, 50%)`;
                spectrumCtx.fillRect(x, height - barHeight, barWidth, barHeight);

                x += barWidth + 1;
                if (x > width) break;
            }
        }

        // Event listeners
        startBtn.addEventListener('click', startCapture);
        stopBtn.addEventListener('click', stopCapture);

        // Initialize on load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }

        // Cleanup on unload
        window.addEventListener('beforeunload', stopCapture);
    </script>
</body>
</html>
