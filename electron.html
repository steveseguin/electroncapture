<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
	<title>Electron Capture</title>
	<style>
	html {
		border: 0;
		margin: 0;
		outline: 0;
		overflow: hidden;
	}
	body {
		padding: 0 0px;
		height: 100%;
		width: 100%;
		background: linear-gradient(to top, #363644 50%, #151b29);
		font-size: 2em;
		font-family: Helvetica, Arial, sans-serif;
		display: flex;
		flex-flow: column;
		border: 0;
		margin: 0;
		outline: 0;
	}
	.container {
		font-size: 20px;
		align-self: center;
		margin: auto auto;
	}

	/* Header bar */
	#header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		width: 100%;
		background-color: #101520;
		-webkit-app-region: drag;
		color: #6f6f6f;
		font-size: 20px;
		line-height: 20px;
		padding: 5px 10px;
		letter-spacing: 3px;
		font-weight: bold;
		box-sizing: border-box;
	}
	#hamburger-btn {
		-webkit-app-region: no-drag;
		background: none;
		border: none;
		color: #888;
		font-size: 22px;
		cursor: pointer;
		padding: 5px 8px;
		border-radius: 5px;
		transition: all 0.2s;
	}
	#hamburger-btn:hover {
		color: #00F6FF;
		background: rgba(0, 246, 255, 0.1);
	}

	/* URL Input - matches original exactly */
	div#urlInput {
		margin: 4em;
		display: flex;
		flex-direction: row;
	}
	label[for="changeText"] {
		font-size: 3em;
		color: #00F6FF;
		text-shadow: 0px 0px 30px #00f6ff;
		padding-top: 5px;
		padding-right: 10px;
	}
	#inputCombo {
		display: flex;
		flex-direction: row;
		flex-wrap: nowrap;
		flex-grow: 1;
	}
	input#changeText {
		font-size: 1em;
		align-self: center;
		width: 100%;
		padding: 1em;
		font-weight: bold;
		background: white;
		border: 4px solid white;
		box-shadow: 0px 30px 40px -32px #6aab23, 0 2px 0px #6aab23;
		border-top-left-radius: 10px;
		border-bottom-left-radius: 10px;
		transition: all 0.2s linear;
		box-sizing: border-box;
		border-bottom-right-radius: 0;
		border-top-right-radius: 0;
	}
	input#changeText:focus {
		outline: none;
	}
	#gobutton {
		font-size: 20px;
		font-weight: bold;
		border: none;
		background: #6aab23;
		display: flex;
		border-radius: 0px;
		border-top-right-radius: 10px;
		border-bottom-right-radius: 10px;
		box-shadow: 0 12px 15px -10px #5ca70b, 0 2px 0px #6aab23;
		color: white;
		cursor: pointer;
		box-sizing: border-box;
		align-items: center;
		padding: 0 1em;
	}

	/* Dropdowns - matches original exactly */
	div#audioOutputContainer, #history {
		display: flex;
		flex-direction: row;
		flex-wrap: nowrap;
		justify-content: center;
		margin: 4em;
	}
	label[for="audioOutput"] {
		font-size: 3em;
		color: #FE53BB;
		text-shadow: 0px 0px 30px #fe53bb;
		padding-right: 10px;
	}
	label[for="lastUrls"] {
		font-size: 3em;
		color: #1a1;
		text-shadow: 0px 0px 30px #1a1;
		padding-right: 10px;
		cursor: pointer;
	}
	#audioOutput, #lastUrls {
		font-size: calc(16px + 0.3vw);
		width: 730px;
		height: 100%;
		flex: 20;
		border-radius: 10px;
		padding: 1em;
		background: #eaeaea;
		cursor: pointer;
	}

	/* Publish button row */
	#publish-row {
		display: flex;
		justify-content: center;
		margin: 2em 4em 0 4em;
	}
	#publish-btn {
		display: flex;
		align-items: center;
		gap: 8px;
		padding: 10px 20px;
		background: transparent;
		border: 2px solid #00F6FF;
		border-radius: 10px;
		color: #00F6FF;
		font-size: 14px;
		font-weight: 600;
		cursor: pointer;
		transition: all 0.2s;
	}
	#publish-btn:hover {
		background: rgba(0, 246, 255, 0.15);
		box-shadow: 0 0 15px rgba(0, 246, 255, 0.3);
	}

	/* Messages & Version */
	#messageDiv {
		font-size: .7em;
		color: #DDD;
		transition: all 0.5s linear;
		font-style: italic;
		opacity: 0;
		text-align: center;
		margin: 10px 0;
	}
	#version {
		margin: 0 auto;
		font-size: 30%;
		display: inline-block;
		color: #000A;
		right: 3px;
		position: absolute;
		bottom: 0;
	}

	/* Update warning */
	#electronVersion {
		background: #8500f7;
		box-shadow: 0px 0px 50px 10px #8500f7ab, inset 0px 0px 10px 2px #8d08ffba;
		border: 2px solid #8500f7;
		border-radius: 10px;
		width: 90%;
		padding: 1em;
		margin: 0 auto;
		color: white;
		font-size: 1.3em;
		margin-bottom: 20px;
		display: none;
	}
	#electronVersion a {
		color: white;
	}

	/* Side Menu */
	#side-menu {
		position: fixed;
		top: 0;
		right: -320px;
		width: 300px;
		height: 100%;
		background: linear-gradient(to bottom, #151b29, #1a1a2e);
		box-shadow: -5px 0 20px rgba(0, 0, 0, 0.5);
		z-index: 1000;
		transition: right 0.3s ease;
		overflow-y: auto;
		display: flex;
		flex-direction: column;
	}
	#side-menu.open { right: 0; }
	#menu-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		padding: 15px 20px;
		background: #101520;
		border-bottom: 1px solid #333;
	}
	#menu-header h3 {
		margin: 0;
		color: #00F6FF;
		font-size: 16px;
	}
	#menu-close {
		background: none;
		border: none;
		color: #888;
		font-size: 24px;
		cursor: pointer;
		padding: 0;
	}
	#menu-close:hover { color: #FE53BB; }
	.menu-section {
		padding: 15px 20px;
		border-bottom: 1px solid #333;
	}
	.menu-section-title {
		font-size: 12px;
		color: #888;
		text-transform: uppercase;
		letter-spacing: 1px;
		margin-bottom: 12px;
	}
	.menu-item {
		display: flex;
		align-items: center;
		gap: 10px;
		padding: 10px 0;
		color: #ddd;
		text-decoration: none;
		cursor: pointer;
		font-size: 14px;
		transition: color 0.2s;
	}
	.menu-item:hover { color: #00F6FF; }
	.menu-toggle {
		display: flex;
		align-items: center;
		justify-content: space-between;
		padding: 10px 0;
	}
	.menu-toggle label {
		color: #ddd;
		cursor: pointer;
		font-size: 14px;
	}
	.toggle-switch {
		position: relative;
		width: 44px;
		height: 24px;
	}
	.toggle-switch input {
		opacity: 0;
		width: 0;
		height: 0;
	}
	.toggle-slider {
		position: absolute;
		cursor: pointer;
		top: 0; left: 0; right: 0; bottom: 0;
		background-color: #444;
		border-radius: 24px;
		transition: 0.3s;
	}
	.toggle-slider:before {
		position: absolute;
		content: "";
		height: 18px;
		width: 18px;
		left: 3px;
		bottom: 3px;
		background-color: white;
		border-radius: 50%;
		transition: 0.3s;
	}
	.toggle-switch input:checked + .toggle-slider { background-color: #00F6FF; }
	.toggle-switch input:checked + .toggle-slider:before { transform: translateX(20px); }
	.menu-select {
		width: 100%;
		padding: 8px 12px;
		background: #2a2a3e;
		border: 1px solid #444;
		border-radius: 6px;
		color: white;
		font-size: 14px;
		margin-top: 8px;
	}
	#menu-version {
		padding: 15px 20px;
		color: #666;
		font-size: 12px;
		margin-top: auto;
	}

	/* Modal */
	#modal-overlay {
		position: fixed;
		top: 0; left: 0;
		width: 100%; height: 100%;
		background: rgba(0, 0, 0, 0.7);
		backdrop-filter: blur(5px);
		z-index: 2000;
		display: none;
		justify-content: center;
		align-items: center;
	}
	#modal-overlay.show { display: flex; }
	#modal {
		background: linear-gradient(to bottom, #151b29, #1a1a2e);
		border: 1px solid #333;
		border-radius: 15px;
		padding: 25px;
		width: 90%;
		max-width: 400px;
		box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
		color: white;
	}
	#modal-title {
		font-size: 18px;
		font-weight: bold;
		margin-bottom: 10px;
		color: #00F6FF;
	}
	#modal-desc {
		color: #999;
		font-size: 13px;
		margin-bottom: 15px;
		line-height: 1.5;
	}
	#modal-desc code {
		background: #333;
		padding: 2px 5px;
		border-radius: 3px;
		font-size: 12px;
	}
	.modal-field {
		margin-bottom: 12px;
	}
	.modal-field label {
		display: block;
		color: #888;
		font-size: 12px;
		margin-bottom: 4px;
	}
	.modal-field label span {
		color: #666;
	}
	.modal-input {
		width: 100%;
		padding: 10px 12px;
		font-size: 14px;
		background: #2a2a3e;
		border: 1px solid #444;
		border-radius: 8px;
		color: white;
		box-sizing: border-box;
	}
	.modal-input:focus {
		outline: none;
		border-color: #00F6FF;
	}
	#modal-buttons {
		display: flex;
		gap: 10px;
		justify-content: flex-end;
		margin-top: 15px;
	}
	.modal-btn {
		padding: 10px 18px;
		border: none;
		border-radius: 8px;
		font-size: 14px;
		font-weight: 600;
		cursor: pointer;
		transition: all 0.2s;
	}
	.modal-btn.cancel {
		background: #444;
		color: white;
	}
	.modal-btn.cancel:hover { background: #555; }
	.modal-btn.confirm {
		background: #00F6FF;
		color: #000;
	}
	.modal-btn.confirm:hover { background: #33f8ff; }

	/* Responsive */
	@media only screen and (max-width: 1030px) {
		body { zoom: 0.9; }
	}
	@media only screen and (max-width: 940px) {
		body { zoom: 0.74; }
		.container { max-width: 99%; }
		div#urlInput, div#audioOutputContainer, #history, #publish-row { margin: 2em; }
	}
	@media only screen and (max-width: 840px) {
		body { zoom: 0.64; }
	}
	@media only screen and (max-height: 639px) {
		div#urlInput, div#audioOutputContainer, #history, #publish-row { margin: 2em; }
	}
	@media only screen and (max-height: 380px) {
		div#urlInput, div#audioOutputContainer, #history, #publish-row { margin: 1em; }
	}
	</style>
</head>
<body>
	<div id="header">
		<span>Electron Capture</span>
		<button id="hamburger-btn" onclick="toggleMenu()" title="Settings">&#9776;</button>
	</div>

	<div class="container">
		<div id="electronVersion">
			<a href="https://github.com/steveseguin/electroncapture/releases/latest">Electron Capture <span id="currentElectronVersion"></span></a> is now available!
		</div>

		<div id="publish-row">
			<button id="publish-btn" onclick="showPublishModal()" title="Share your screen to VDO.Ninja">
				<span>Publish Screen to VDO.Ninja</span>
			</button>
		</div>

		<div id="messageDiv" style="display:block"><br /></div>

		<div class="container">
			<div id="urlInput" title="Put the link you want to load here">
				<label for="changeText">&#9654;</label>
				<div id="inputCombo">
					<input type="text" id="changeText" value="https://vdo.ninja/" onkeyup="enterPressed(event, gohere);" />
					<button onclick="gohere();" id="gobutton">GO</button>
				</div>
			</div>

			<div id="audioOutputContainer" title="This option will only work with the official vdo.ninja domain">
				<label for="audioOutput">&#127911;</label>
				<select id="audioOutput"></select>
			</div>

			<div id="history" title="History of past links used. Click icon to clear.">
				<label for="lastUrls" onclick="resetHistory()">&#128220;</label>
				<select id="lastUrls" onchange="setUrl()"></select>
			</div>
		</div>
	</div>

	<div id="version"></div>

	<!-- Side Menu -->
	<div id="side-menu">
		<div id="menu-header">
			<h3>Settings</h3>
			<button id="menu-close" onclick="toggleMenu()">&times;</button>
		</div>
		<div class="menu-section">
			<div class="menu-section-title">Window</div>
			<div class="menu-toggle">
				<label>Always on Top</label>
				<label class="toggle-switch">
					<input type="checkbox" id="toggle-pin" onchange="toggleAlwaysOnTop()">
					<span class="toggle-slider"></span>
				</label>
			</div>
			<div class="menu-toggle">
				<label>DPI Compensation</label>
				<label class="toggle-switch">
					<input type="checkbox" id="toggle-dpi" checked onchange="toggleDPI()">
					<span class="toggle-slider"></span>
				</label>
			</div>
			<div style="padding: 10px 0;">
				<label style="color: #ddd; font-size: 14px;">Window Size</label>
				<select id="window-size" class="menu-select" onchange="setWindowSize()">
					<option value="1280x720">720p (1280x720)</option>
					<option value="1920x1080">1080p (1920x1080)</option>
					<option value="854x480">480p (854x480)</option>
					<option value="640x360">360p (640x360)</option>
				</select>
			</div>
		</div>
		<div class="menu-section">
			<div class="menu-section-title">Help</div>
			<a class="menu-item" onclick="openExternal('https://docs.vdo.ninja/')">VDO.Ninja Docs</a>
			<a class="menu-item" onclick="openExternal('https://docs.vdo.ninja/getting-started/obs')">OBS Setup Guide</a>
			<a class="menu-item" onclick="openExternal('https://discord.vdo.ninja')">Discord Community</a>
		</div>
		<div class="menu-section">
			<div class="menu-section-title">Links</div>
			<a class="menu-item" onclick="openExternal('https://vdo.ninja')">VDO.Ninja</a>
			<a class="menu-item" onclick="openExternal('https://github.com/steveseguin/electroncapture')">GitHub</a>
			<a class="menu-item" onclick="openExternal('https://github.com/steveseguin/electroncapture/issues')">Report Issue</a>
		</div>
		<div id="menu-version">Electron Capture <span id="app-version">v2.23.1</span></div>
	</div>

	<!-- Publish Modal -->
	<div id="modal-overlay" onclick="closeModal(event)">
		<div id="modal" onclick="event.stopPropagation()">
			<div id="modal-title">Publish Your Screen</div>
			<div id="modal-desc">
				Share your screen to VDO.Ninja. All fields optional.<br>
				Viewers use: <code>vdo.ninja/?view=ID</code>
			</div>
			<div class="modal-field">
				<label>Your Name <span>(optional)</span></label>
				<input type="text" id="modal-label" class="modal-input" placeholder="e.g., Player1" />
			</div>
			<div class="modal-field">
				<label>Stream ID <span>(optional)</span></label>
				<input type="text" id="modal-push" class="modal-input" placeholder="e.g., mygame" />
			</div>
			<div class="modal-field">
				<label>Room <span>(optional)</span></label>
				<input type="text" id="modal-room" class="modal-input" placeholder="e.g., myroom" />
			</div>
			<div class="modal-field">
				<label>Password <span>(optional)</span></label>
				<input type="text" id="modal-password" class="modal-input" placeholder="e.g., secret123" onkeyup="if(event.keyCode===13)confirmPublish();" />
			</div>
			<div id="modal-buttons">
				<button class="modal-btn cancel" onclick="closeModal()">Cancel</button>
				<button class="modal-btn confirm" onclick="confirmPublish()">Start</button>
			</div>
		</div>
	</div>

<script>
var publishSettings = JSON.parse(localStorage.getItem('publishSettings') || '{}');

function showPublishModal() {
	document.getElementById('modal-label').value = publishSettings.label || '';
	document.getElementById('modal-push').value = publishSettings.push || '';
	document.getElementById('modal-room').value = publishSettings.room || '';
	document.getElementById('modal-password').value = publishSettings.password || '';
	document.getElementById('modal-overlay').classList.add('show');
	setTimeout(() => document.getElementById('modal-label').focus(), 100);
}

function closeModal(event) {
	if (event && event.target !== document.getElementById('modal-overlay')) return;
	document.getElementById('modal-overlay').classList.remove('show');
}

function confirmPublish() {
	const label = document.getElementById('modal-label').value.trim();
	const push = document.getElementById('modal-push').value.trim();
	const room = document.getElementById('modal-room').value.trim();
	const password = document.getElementById('modal-password').value.trim();

	publishSettings = { label, push, room, password };
	localStorage.setItem('publishSettings', JSON.stringify(publishSettings));

	let url = 'https://vdo.ninja/?screenshare&autostart';
	if (label) url += '&label=' + encodeURIComponent(label);
	if (push) url += '&push=' + encodeURIComponent(push);
	if (room) url += '&room=' + encodeURIComponent(room);
	if (password) url += '&password=' + encodeURIComponent(password);

	document.getElementById('changeText').value = url;
	closeModal();
	gohere();
}

function toggleMenu() {
	document.getElementById('side-menu').classList.toggle('open');
}

function toggleAlwaysOnTop() {
	const checked = document.getElementById('toggle-pin').checked;
	if (window.electronApi && window.electronApi.setAlwaysOnTop) {
		window.electronApi.setAlwaysOnTop(checked);
	}
}

function toggleDPI() {
	const checked = document.getElementById('toggle-dpi').checked;
	localStorage.setItem('dpiCompensation', checked ? '1' : '0');
}

function setWindowSize() {
	const size = document.getElementById('window-size').value;
	const [w, h] = size.split('x').map(Number);
	if (window.electronApi && window.electronApi.setWindowSize) {
		window.electronApi.setWindowSize(w, h);
	}
}

function openExternal(url) {
	if (window.electronApi && window.electronApi.openExternal) {
		window.electronApi.openExternal(url);
	} else {
		window.open(url, '_blank');
	}
	toggleMenu();
}

function setUrl() {
	document.querySelector("#changeText").value = document.querySelector("#lastUrls").value;
	gohere();
}

function resetHistory() {
	if (confirm('Clear URL history?')) {
		localStorage.removeItem('lastUrls');
		document.querySelector('#lastUrls').innerHTML = '';
		document.getElementById('history').style.display = 'none';
		lastUrls = [];
	}
}

function enterPressed(event, callback) {
	if (event.keyCode === 13) {
		event.preventDefault();
		callback();
	}
}

function updateURLParameter(url, param, paramVal) {
	var newAdditionalURL = "";
	var tempArray = url.split("?");
	var baseURL = tempArray[0];
	var additionalURL = tempArray[1];
	var temp = "";
	if (additionalURL) {
		tempArray = additionalURL.split("&");
		for (var i = 0; i < tempArray.length; i++) {
			if (tempArray[i].split('=')[0] != param) {
				newAdditionalURL += temp + tempArray[i];
				temp = "&";
			}
		}
	}
	return baseURL + "?" + newAdditionalURL + temp + param + "=" + paramVal;
}

function modURL() {
	var url = document.getElementById('changeText').value.trim();
	if (url.startsWith("obs.ninja") || url.startsWith("vdo.ninja") ||
		url.startsWith("youtube.com") || url.startsWith("twitch.tv")) {
		url = "https://" + url;
	} else if (!url.startsWith("http://") && !url.startsWith("https://") && !url.startsWith("file:")) {
		url = "https://" + url;
	}
	return url;
}

function addUrlToHistory(url) {
	if (lastUrls == undefined) lastUrls = [];
	if (lastUrls[0] != url) {
		lastUrls.unshift(url);
		if (lastUrls.length > 100) lastUrls.pop();
	}
}

function gohere() {
	addUrlToHistory(document.getElementById('changeText').value);
	localStorage.setItem('lastUrls', JSON.stringify(lastUrls));
	window.location = modURL();
}

var audioOutputSelect = document.querySelector('select#audioOutput');
audioOutputSelect.disabled = !('sinkId' in HTMLMediaElement.prototype);
var listed = false;

audioOutputSelect.onclick = function() { getPermissions(); };
audioOutputSelect.onchange = function() {
	var url = document.getElementById('changeText').value;
	url = updateURLParameter(url, "sink", audioOutputSelect.value);
	document.getElementById('changeText').value = url;
};

function getPermissions() {
	if (listed) return;
	navigator.mediaDevices.getUserMedia({audio: true, video: false}).then((stream) => {
		navigator.mediaDevices.enumerateDevices().then(gotDevices).catch(console.error);
		stream.getTracks().forEach(track => track.stop());
		listed = true;
	}).catch(function() {
		document.getElementById("messageDiv").innerHTML = "Please allow microphone access to list audio devices.";
		document.getElementById("messageDiv").style.opacity = "1";
	});
}

function gotDevices(deviceInfos) {
	for (let i = 0; i < deviceInfos.length; ++i) {
		if (deviceInfos[i].kind === 'audiooutput') {
			const option = document.createElement('option');
			option.value = deviceInfos[i].deviceId;
			option.text = deviceInfos[i].label || `Speaker ${audioOutputSelect.length + 1}`;
			audioOutputSelect.appendChild(option);
		}
	}
	listed = true;
}

if (navigator.userAgent.toLowerCase().indexOf(' electron/') > -1) {
	var urlParams = new URLSearchParams(window.location.search);
	var ver = urlParams.get('version') || urlParams.get('ver');
	if (ver) {
		document.getElementById("version").textContent = "v" + ver;
		document.getElementById("app-version").textContent = "v" + ver;
		fetch('https://api.github.com/repos/steveseguin/electroncapture/releases/latest')
			.then(r => r.json())
			.then(data => {
				var c = ver.replace('v','').split('.');
				var l = data.tag_name.replace('v','').split('.');
				for (var i = 0; i < 3; i++) {
					if (parseInt(l[i]||0) > parseInt(c[i]||0)) {
						document.getElementById("electronVersion").style.display = "block";
						document.getElementById("currentElectronVersion").textContent = data.tag_name;
						break;
					} else if (parseInt(l[i]||0) < parseInt(c[i]||0)) break;
				}
			}).catch(console.error);
	}
}

var lastUrls = JSON.parse(localStorage.getItem('lastUrls'));
if (lastUrls && lastUrls.length > 0) {
	document.querySelector("#changeText").value = lastUrls[0];
	lastUrls.forEach((url) => {
		var o = document.createElement('option');
		o.value = url;
		o.text = url;
		document.querySelector("#lastUrls").appendChild(o);
	});
} else {
	document.getElementById('history').style.display = 'none';
}

document.addEventListener('DOMContentLoaded', () => { getPermissions(); });

document.addEventListener('click', (e) => {
	const menu = document.getElementById('side-menu');
	const btn = document.getElementById('hamburger-btn');
	if (menu.classList.contains('open') && !menu.contains(e.target) && e.target !== btn) {
		menu.classList.remove('open');
	}
});

document.addEventListener('keydown', (e) => {
	if (e.key === 'Escape') {
		closeModal();
		document.getElementById('side-menu').classList.remove('open');
	}
});
</script>
</body>
</html>
